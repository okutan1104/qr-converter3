<!doctype html>
<html lang="ja">
<head>
<meta charset="utf-8" />
<meta name="viewport" content="width=device-width,initial-scale=1" />
<title>ãƒãƒ¼ã‚³ãƒ¼ãƒ‰â†’QRå¤‰æ›ãƒ„ãƒ¼ãƒ«ï¼ˆã‚«ãƒ¡ãƒ©ON/OFFå¯¾å¿œï¼‰</title>
<script src="https://unpkg.com/@zxing/library@latest"></script>
<script src="https://cdn.jsdelivr.net/npm/qrcodejs/qrcode.min.js"></script>
<style>
body {
  font-family: system-ui, sans-serif;
  background: #f8fafc;
  padding: 1.5rem;
  text-align: center;
}
#camera {
  width: 320px;
  height: 240px;
  background: #000;
  border-radius: 8px;
  display: none;
}
#qrcode {
  margin-top: 1rem;
}
button {
  margin: 0.5rem;
  padding: 0.7rem 1.5rem;
  border: none;
  border-radius: 8px;
  background: #007bff;
  color: white;
  font-size: 1rem;
}
input[type="text"] {
  padding: 0.5rem;
  width: 250px;
  border: 1px solid #ccc;
  border-radius: 6px;
  font-size: 1rem;
}
#barcodeResult {
  font-size: 1.1rem;
  margin-top: 0.5rem;
  color: #333;
}
</style>
</head>
<body>

<h2>ğŸ“¦ ãƒãƒ¼ã‚³ãƒ¼ãƒ‰ â†’ QRã‚³ãƒ¼ãƒ‰å¤‰æ›ãƒ„ãƒ¼ãƒ«</h2>

<!-- ã‚«ãƒ¡ãƒ©ã‚¨ãƒªã‚¢ -->
<video id="camera" autoplay muted></video>

<!-- æ‰‹å…¥åŠ›ãƒ¢ãƒ¼ãƒ‰ -->
<div id="manualInputArea">
  <p>ğŸ“¥ ãƒãƒ¼ã‚³ãƒ¼ãƒ‰ç•ªå·ã‚’å…¥åŠ›ã—ã¦QRã‚’ç”Ÿæˆ</p>
  <input id="manualInput" type="text" placeholder="ãƒãƒ¼ã‚³ãƒ¼ãƒ‰å€¤ã‚’å…¥åŠ›">
  <button id="generateBtn">QRå¤‰æ›</button>
</div>

<p id="barcodeResult">ã‚«ãƒ¡ãƒ©ã‚’ONã«ã™ã‚‹ã¨ã‚¹ã‚­ãƒ£ãƒ³ã§ãã¾ã™</p>
<div id="qrcode"></div>

<!-- ãƒœã‚¿ãƒ³ -->
<button id="cameraOnBtn">ğŸ“· ã‚«ãƒ¡ãƒ©ON</button>
<button id="cameraOffBtn">ğŸ›‘ ã‚«ãƒ¡ãƒ©OFF</button>

<script>
const codeReader = new ZXing.BrowserMultiFormatReader();
const videoElement = document.getElementById('camera');
const resultElement = document.getElementById('barcodeResult');
const qrContainer = document.getElementById('qrcode');
const inputField = document.getElementById('manualInput');
const manualArea = document.getElementById('manualInputArea');

let scanning = false;

async function startCamera() {
  try {
    const devices = await codeReader.listVideoInputDevices();
    const selectedDeviceId = devices[0]?.deviceId;

    // ã‚«ãƒ¡ãƒ©è¡¨ç¤º
    videoElement.style.display = "block";
    manualArea.style.display = "none";

    await codeReader.decodeFromVideoDevice(selectedDeviceId, videoElement, (result, err) => {
      if (result) {
        const barcodeText = result.getText();
        resultElement.textContent = 'èª­å–çµæœï¼š' + barcodeText;
        makeQR(barcodeText);
      }
      if (err && !(err instanceof ZXing.NotFoundException)) {
        console.error(err);
      }
    });
    scanning = true;
  } catch (e) {
    console.error(e);
    resultElement.textContent = 'ã‚«ãƒ¡ãƒ©ã®èµ·å‹•ã«å¤±æ•—ã—ã¾ã—ãŸã€‚æ¨©é™ã‚’ç¢ºèªã—ã¦ãã ã•ã„ã€‚';
  }
}

function stopCamera() {
  codeReader.reset();
  scanning = false;
  videoElement.style.display = "none";
  manualArea.style.display = "block";
  resultElement.textContent = 'ã‚«ãƒ¡ãƒ©åœæ­¢ä¸­ï¼šæ‰‹å…¥åŠ›ã§QRç”Ÿæˆå¯èƒ½ã§ã™ã€‚';
}

// QRç”Ÿæˆå…±é€šé–¢æ•°
function makeQR(text) {
  qrContainer.innerHTML = '';
  new QRCode(qrContainer, {
    text: text,
    width: 200,
    height: 200,
  });
}

// æ‰‹å…¥åŠ›å¤‰æ›
document.getElementById('generateBtn').addEventListener('click', () => {
  const val = inputField.value.trim();
  if (val === '') {
    alert('ãƒãƒ¼ã‚³ãƒ¼ãƒ‰å€¤ã‚’å…¥åŠ›ã—ã¦ãã ã•ã„');
    return;
  }
  resultElement.textContent = 'å…¥åŠ›çµæœï¼š' + val;
  makeQR(val);
});

// ã‚«ãƒ¡ãƒ©ON/OFFåˆ‡æ›¿ãƒœã‚¿ãƒ³
document.getElementById('cameraOnBtn').addEventListener('click', startCamera);
document.getElementById('cameraOffBtn').addEventListener('click', stopCamera);

// åˆæœŸã¯ã‚«ãƒ¡ãƒ©OFF
stopCamera();
</script>

</body>
</html>
